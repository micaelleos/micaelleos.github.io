name: Sync Notion to Jekyll

on:
  # Roda a cada hora
  schedule:
    - cron: '0 * * * *'
  
  # Permite rodar manualmente
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm install notion-to-md @notionhq/client dotenv
      
      - name: Create sync script
        run: |
          cat > sync-notion.js << 'SCRIPT_EOF'
          const { Client } = require('@notionhq/client');
          const { NotionToMarkdown } = require('notion-to-md');
          const fs = require('fs');
          const path = require('path');

          const notion = new Client({ auth: process.env.NOTION_TOKEN });
          const n2m = new NotionToMarkdown({ notionClient: notion });

          async function queryDatabase(databaseId, body) {
            // Prefer the SDK helper when available, otherwise fall back to raw request
            if (notion.databases && typeof notion.databases.query === 'function') {
              return await notion.databases.query(Object.assign({ database_id: databaseId }, body));
            }
            console.warn('notion.databases.query not available; using fallback fetch to Notion API');
            const url = `https://api.notion.com/v1/databases/${databaseId}/query`;
            const res = await fetch(url, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.NOTION_TOKEN}`,
                'Notion-Version': '2022-06-28',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(body || {})
            });
            const data = await res.json();
            if (!res.ok) {
              const err = new Error(`Notion API error: ${data.message || res.statusText}`);
              err.response = data;
              throw err;
            }
            return data;
          }

          async function syncPosts() {
            try {
              const filter = {
                filter: {
                  property: 'Published',
                  checkbox: { equals: true }
                }
              };

              // Buscar posts publicados (usa fallback se necessÃ¡rio)
              const response = await queryDatabase(process.env.NOTION_DATABASE_ID, filter);

              console.log(`Found ${response.results?.length || 0} published posts`);

              const postsDir = path.join(process.cwd(), '_posts');
              if (!fs.existsSync(postsDir)) fs.mkdirSync(postsDir, { recursive: true });

              for (const page of (response.results || [])) {
                const pageId = page.id;
                const title = page.properties?.Title?.title?.[0]?.plain_text || 'Untitled';
                const slug = page.properties?.Slug?.rich_text?.[0]?.plain_text || 'untitled';
                const date = page.properties?.Date?.date?.start || new Date().toISOString().split('T')[0];
                const tags = page.properties?.Tags?.multi_select?.map(t => t.name) || [];
                const category = page.properties?.Category?.select?.name || '';
                const info = page.properties?.Info?.rich_text?.[0]?.plain_text || '';
                const tech = page.properties?.Tech?.rich_text?.[0]?.plain_text || '';
                const type = page.properties?.Type?.select?.name || 'post';
                const image = page.properties?.Image?.url || '';

                const mdblocks = await n2m.pageToMarkdown(pageId);
                const mdString = n2m.toMarkdownString(mdblocks);

                let frontmatter = `---\nlayout: post\ntitle: "${title.replace(/"/g, '\\"')}"\n`;
                if (info) frontmatter += `info: ${info.replace(/"/g, '\\"')}\n`;
                frontmatter += `date: ${date}\n`;
                if (tech) frontmatter += `tech: "${tech}"\n`;
                if (type) frontmatter += `type: ${type}\n`;
                if (image) frontmatter += `image: ${image}\n`;
                if (category) frontmatter += `category: ${category}\n`;
                if (tags.length) frontmatter += `tags: [${tags.map(t => t).join(', ')}]\n`;
                frontmatter += `---\n\n`;

                const fullContent = frontmatter + mdString;
                const fileName = `${date}-${slug}.md`;
                fs.writeFileSync(path.join(postsDir, fileName), fullContent, 'utf8');
                console.log(`âœ“ Synced: ${fileName}`);
              }

              console.log('Sync completed successfully!');
            } catch (error) {
              console.error('Error syncing posts:', error);
              process.exit(1);
            }
          }

          syncPosts().catch(err => {
            console.error('Fatal error:', err);
            process.exit(1);
          });
          SCRIPT_EOF
      
      - name: Run sync
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: node sync-notion.js
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add _posts/
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ”„ Sync posts from Notion" && git push)
